<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <!-- PWA CAPABILITIES -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#c96062">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Favicon for browsers -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/icon-16.png">
    <link rel="apple-touch-icon" href="assets/icons/icon-180.png">
    <title>Gubevu Electrical - Quote & Invoice</title>
    <style>
        :root {
            --primary-color: #c96062;
            --table-header-bg: #D9686A;
            --table-header-color: #FFFFFF;
            --text-color: #333;
            --light-text: #666;
            --border-color: #ccc;
            --vat-rate: 0.15;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 25px 35px;
            background-color: #fff;
            color: var(--text-color);
            font-size: 13px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 25px;
        }
        
        /* --- HEADER WITH LOGO ON FAR RIGHT --- */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--primary-color);
            position: relative;
        }
        .company-details {
            flex: 1;
            margin-left: 0;
        }
        .company-details p {
            margin: 0 0 4px 0;
            font-size: 12px;
            line-height: 1.3;
        }
        .company-details p:first-child {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--primary-color);
        }
        .logo-container-right {
            width: 180px;
            height: 110px;
            border: 1px solid #eee;
            background-color: #f9f9f9;
            position: absolute;
            right: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-placeholder {
            color: #999;
            font-size: 11px;
            text-align: center;
            padding: 0 5px;
        }
        
        /* --- DOCUMENT TYPE SELECTOR --- */
        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-top: 10px;
            margin-left: 0;
        }
        .document-type-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 0;
        }
        .document-title {
            color: var(--primary-color);
            font-size: 18px;
            font-weight: normal;
            display: inline-block;
            min-width: 80px;
        }
        .invoice-title {
            font-weight: bold !important;
        }
        .document-selector {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }
        .document-selector:focus {
            outline: 1px solid var(--primary-color);
        }
        .document-details {
            text-align: right;
            font-size: 12px;
            line-height: 1.4;
        }
        .document-details span {
            font-weight: bold;
        }
        
        /* --- CLIENT SECTION - 45% WIDTH --- */
        .client-section {
            margin-bottom: 25px;
            padding: 0; /* Changed to 0 as requested */
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #eee;
            width: 45%;
            float: left;
            box-sizing: border-box;
            margin-left: 0;
        }
        .client-header {
            font-size: 13px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: block;
            padding: 15px 15px 0 15px;
        }
        .client-name-row {
            margin-bottom: 12px;
            padding: 0 15px;
        }
        .client-name-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            font-weight: 400;
            box-sizing: border-box;
            background: white;
        }
        .client-address-textarea {
            width: calc(100% - 30px);
            margin: 0 15px 15px 15px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            resize: vertical;
            min-height: 100px;
            max-height: 120px;
            line-height: 1.4;
            background: white;
        }
        .client-address-textarea::placeholder {
            color: #999;
            font-size: 12px;
        }
        .client-address-textarea:focus {
            outline: 1px solid var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* --- BANKING DETAILS SECTION - BOTTOM LEFT --- */
        .banking-section {
            margin-top: 40px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #eee;
            width: 45%;
            float: left;
            box-sizing: border-box;
            display: none;
            page-break-inside: avoid;
            margin-left: 0;
        }
        .banking-header {
            font-size: 13px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: block;
        }
        .banking-details {
            font-size: 12px;
            line-height: 1.4;
        }
        .banking-details p {
            margin: 6px 0;
        }
        .banking-details strong {
            color: var(--text-color);
            font-weight: bold;
            display: inline-block;
            min-width: 110px;
        }
        
        /* Clear float for sections below */
        .clear-float {
            clear: both;
        }
        
        /* --- ITEMS TABLE - CLEAN ALIGNMENT --- */
        .item-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 12px;
            table-layout: fixed;
            margin-left: 0;
        }
        .item-table th, .item-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
            font-family: Arial, sans-serif;
        }
        .item-table th {
            background-color: var(--table-header-bg);
            color: var(--table-header-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            border: none;
            padding: 7px 10px;
        }
        .item-table th:first-child {
            border-top-left-radius: 4px;
            padding-left: 10px;
        }
        .item-table th:last-child {
            border-top-right-radius: 4px;
        }
        
        /* Column widths - Clean 5-column layout */
        .item-table th:nth-child(1),
        .item-table td:nth-child(1) {
            width: 80px;
            text-align: left;
            padding-left: 10px;
        }
        .item-table th:nth-child(2),
        .item-table td:nth-child(2) {
            width: auto;
            min-width: 200px;
            text-align: left;
            padding-left: 10px;
            position: relative; /* For delete button positioning */
        }
        .item-table th:nth-child(3),
        .item-table td:nth-child(3) {
            width: 50px;
            text-align: center;
        }
        .item-table th:nth-child(4),
        .item-table td:nth-child(4) {
            width: 90px;
            text-align: right;
            white-space: nowrap;
            padding-right: 10px;
        }
        .item-table th:nth-child(5),
        .item-table td:nth-child(5) {
            width: 90px;
            text-align: right;
            white-space: nowrap;
            padding-right: 10px;
        }
        
        .qty-cell {
            text-align: center !important;
        }
        .rate-cell, .total-amount {
            text-align: right !important;
            white-space: nowrap !important;
        }
        .description-cell {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            hyphens: auto;
            min-height: 40px;
            line-height: 1.4;
            position: relative;
            padding-right: 25px; /* Space for delete button */
        }
        
        .item-table td[contenteditable="true"]:focus {
            background-color: #fffff0;
            outline: 1px dashed var(--primary-color);
        }
        
        /* --- DELETE BUTTON STYLES - SIMPLE AND CLEAN --- */
        .delete-btn {
            display: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ff6b6b;
            color: white;
            border: none;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            position: absolute;
            right: 5px;
            top: 10px;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            background-color: #ff5252;
            transform: scale(1.1);
        }
        
        /* Show delete button when row is hovered */
        .item-row:hover .delete-btn {
            display: block;
        }
        
        /* --- TOTALS SECTION - PERFECT ALIGNMENT --- */
        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            margin-right: 10px; /* Matches table cell padding-right */
        }
        .totals-box {
            width: 220px;
            text-align: right;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 12px;
        }
        .total-label {
            color: var(--light-text);
        }
        .total-value {
            min-width: 100px;
            text-align: right;
        }
        .grand-total {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid var(--border-color);
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* --- QUOTE ACCEPTANCE SECTION - BOTTOM LEFT --- */
        .acceptance-section {
            margin-top: 40px;
            width: 45%;
            float: left;
            box-sizing: border-box;
            margin-left: 0;
        }
        .acceptance-line {
            display: flex;
            gap: 40px;
        }
        .acceptance-item {
            flex: 1;
        }
        .acceptance-label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 11px;
            white-space: nowrap;
        }
        .acceptance-text {
            margin-right: 5px;
        }
        .inline-signature-line {
            flex: 1;
            border-bottom: 1px solid var(--light-text);
            height: 16px;
            margin-left: 5px;
        }
        
        /* --- ACTION BUTTONS --- */
        .action-buttons {
            margin-top: 25px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            clear: both;
        }
        .action-buttons button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 13px;
            margin: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .action-buttons button:hover {
            background-color: #b85052;
        }
        
        /* --- PRINT STYLES --- */
        @media print {
            @page {
                margin: 0;
                margin-top: 0.5in;
                margin-bottom: 0.5in;
                size: A4;
            }
            
            body {
                padding: 0 !important;
                margin: 0 !important;
                font-size: 12px;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 20px !important;
                border: none !important;
            }
            
            .action-buttons, 
            .document-selector,
            .delete-btn { 
                display: none !important; 
            }
            
            .client-name-input,
            .client-address-textarea {
                border: none !important;
                padding: 0 !important;
                background: transparent !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            .item-table th {
                background-color: #D9686A !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .logo-container-right {
                border: none !important;
            }
            
            /* Hide browser footers */
            @page {
                @bottom-center {
                    content: "" !important;
                }
                @top-center {
                    content: "" !important;
                }
            }
            
            body::after {
                display: none !important;
            }
            
            /* Prevent page breaks */
            tr {
                page-break-inside: avoid !important;
            }
            
            html > body::after,
            html > body::before {
                display: none !important;
            }
        }

        /* SIMPLE MOBILE FIX - Just prevents breaking */
@media (max-width: 768px) {
    body {
        padding: 15px !important;
        overflow-x: auto; /* Allows horizontal scrolling */
    }
    
    .container {
        min-width: 800px; /* Forces desktop width */
        transform: scale(0.95); /* Slightly smaller to fit */
        transform-origin: top left;
    }
    
    /* Prevent iOS zoom on inputs */
    .client-name-input,
    .client-address-textarea,
    .document-selector {
        font-size: 16px !important;
    }
    
    /* Make table scrollable */
    .item-table {
        overflow-x: auto;
        display: block;
    }
    
    /* Keep delete button visible */
    .item-row:hover .delete-btn {
        display: block !important;
    }
    
    .delete-btn {
        width: 24px;
        height: 24px;
        font-size: 14px;
        right: 8px;
        top: 8px;
    }
}





    </style>
</head>
<body>

    <div class="container" id="document-template">
        
        <!-- HEADER WITH LOGO ON FAR RIGHT -->
        <div class="header-section">
            <div class="company-details">
                <p>Gubevu Electrical</p>
                <p>1919 Flanagan Street Boksburg</p>
                <p>Gauteng</p>
                <p>1475</p>
                <p>+27 810367839</p>
                <p>fiks@gubevuelectrical.com</p>
            </div>
            <div class="logo-container-right">
    <img src="assets/logo.png" alt="Gubevu Electrical Logo" style="width: 180px; height: 110px; object-fit: contain;">
</div>
        </div>

        <!-- DOCUMENT TYPE SELECTOR -->
        <div class="document-header">
            <div class="document-type-container">
                <div class="document-title" id="document-title">QUOTE</div>
                <select class="document-selector" id="document-type">
                    <option value="quote">QUOTE</option>
                    <option value="invoice">INVOICE</option>
                </select>
            </div>
            <div class="document-details">
                <p><span id="document-type-label">QUOTE</span> #: <span id="document-number" contenteditable="true">2508</span></p>
                <p>DATE: <span id="document-date" contenteditable="true">19/09/2025</span></p>
            </div>
        </div>

        <!-- CLIENT SECTION - 45% width with padding 0 -->
        <div class="client-section">
            <span class="client-header">BILL TO</span>
            <div class="client-name-row">
                <input type="text" class="client-name-input" id="client-name-input" 
                       value="Dr SK Matseke Private Hospital" 
                       placeholder="Client/Company Name">
            </div>
            <div>
                <textarea class="client-address-textarea" id="client-address-textarea" 
                          placeholder="Enter full address including street, city, province, postal code, and country">
Accounts Payable Department
23967 Immink Drive, Diepkloof Zone6
Soweto, Gauteng 1862
South Africa</textarea>
            </div>
        </div>

        <div class="clear-float"></div>

        <!-- ITEMS TABLE - CLEAN 5-COLUMN LAYOUT -->
        <table class="item-table" id="item-table">
            <thead>
                <tr>
                    <th>ACTIVITY</th>
                    <th>DESCRIPTION</th>
                    <th>QTY</th>
                    <th>AMOUNT</th>
                    <th>TOTAL</th>
                </tr>
            </thead>
            <tbody>
                <tr class="item-row">
                    <td contenteditable="true">Material</td>
                    <td class="description-cell" contenteditable="true">
                        Supply and deliver - Diesel pump with nozzle and dispensing hose @80l/min
                        <button class="delete-btn" onclick="deleteRow(this)" title="Delete this item">×</button>
                    </td>
                    <td class="qty-cell" contenteditable="true">1</td>
                    <td class="rate-cell" contenteditable="true">R 17,250.00</td>
                    <td class="total-amount">R <span class="line-total">17,250.00</span></td>
                </tr>
                <tr class="item-row">
                    <td contenteditable="true">Labour</td>
                    <td class="description-cell" contenteditable="true">
                        Installation and consumables
                        <button class="delete-btn" onclick="deleteRow(this)" title="Delete this item">×</button>
                    </td>
                    <td class="qty-cell" contenteditable="true">1</td>
                    <td class="rate-cell" contenteditable="true">R 1,650.00</td>
                    <td class="total-amount">R <span class="line-total">1,650.00</span></td>
                </tr>
            </tbody>
        </table>

        <!-- TOTALS SECTION - PERFECTLY ALIGNED -->
        <div class="totals-section">
            <div class="totals-box">
                <div class="total-row">
                    <span class="total-label">SUBTOTAL:</span>
                    <span class="total-value">R <span id="subtotal">18,900.00</span></span>
                </div>
                <div class="total-row">
                    <span class="total-label">VAT (0%):</span>
                    <span class="total-value">R <span id="vat-amount">2,835.00</span></span>
                </div>
                <div class="total-row grand-total">
                    <span>TOTAL:</span>
                    <span class="total-value">R <span id="grand-total">21,735.00</span></span>
                </div>
            </div>
        </div>

        <!-- BANKING DETAILS SECTION - BOTTOM LEFT (Only shown for invoices) -->
        <div class="banking-section" id="banking-section">
            <span class="banking-header">Banking details:</span>
            <div class="banking-details">
                <p><strong>Bank:</strong> Nedbank</p>
                <p><strong>Account Holder:</strong> GUBEVU ELECTRICAL (PTY) LTD</p>
                <p><strong>Account Number:</strong> 1301485233</p>
                <p><strong>Branch:</strong> MTHATHA PLAZA</p>
                <p><strong>Branch Code:</strong> 198765</p>
                <p><strong>Reference:</strong> <span id="invoice-reference">INV-2508</span></p>
            </div>
        </div>

        <!-- QUOTE ACCEPTANCE SECTION - BOTTOM LEFT -->
        <div class="acceptance-section" id="quote-section">
            <div class="acceptance-line">
                <div class="acceptance-item">
                    <div class="acceptance-label">
                        <span class="acceptance-text">Accepted by:</span>
                        <span class="inline-signature-line"></span>
                    </div>
                </div>
                <div class="acceptance-item">
                    <div class="acceptance-label">
                        <span class="acceptance-text">Accepted date:</span>
                        <span class="inline-signature-line"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="action-buttons">
            <button onclick="addRow()">Add Line Item</button>
            <button onclick="printDocument()">Print/Export PDF</button>
            <button onclick="incrementDocumentNumber()">Next Document #</button>
     </div>

    </div>

    <script>
        // --- DOCUMENT TYPE MANAGEMENT ---
        const documentTypeSelect = document.getElementById('document-type');
        const documentTitle = document.getElementById('document-title');
        const documentTypeLabel = document.getElementById('document-type-label');
        const documentNumber = document.getElementById('document-number');
        const quoteSection = document.getElementById('quote-section');
        const bankingSection = document.getElementById('banking-section');
        const invoiceReference = document.getElementById('invoice-reference');

        // Initialize document type
        function initializeDocumentType() {
            const savedType = localStorage.getItem('documentType') || 'quote';
            documentTypeSelect.value = savedType;
            updateDocumentType(savedType);
            
            // Load saved numbers for each type
            const quoteNum = localStorage.getItem('lastQuoteNumber') || '2508';
            const invoiceNum = localStorage.getItem('lastInvoiceNumber') || 'INV-2508';
            
            if (savedType === 'quote') {
                documentNumber.textContent = quoteNum;
            } else {
                documentNumber.textContent = invoiceNum;
                invoiceReference.textContent = invoiceNum;
            }
        }

        function updateDocumentType(type) {
            // Update UI
            if (type === 'quote') {
                documentTitle.textContent = 'QUOTE';
                documentTitle.classList.remove('invoice-title');
                documentTypeLabel.textContent = 'QUOTE';
                quoteSection.style.display = 'block';
                bankingSection.style.display = 'none';
            } else {
                documentTitle.textContent = 'INVOICE';
                documentTitle.classList.add('invoice-title');
                documentTypeLabel.textContent = 'INVOICE';
                quoteSection.style.display = 'none';
                bankingSection.style.display = 'block';
                
                // Update invoice reference with current document number
                invoiceReference.textContent = documentNumber.textContent;
            }
            
            // Save selection
            localStorage.setItem('documentType', type);
        }

        // Event listener for document type change
        documentTypeSelect.addEventListener('change', function() {
            updateDocumentType(this.value);
        });

        // --- FORMAT CURRENCY ---
        function formatCurrency(amount) {
            return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function parseCurrency(value) {
            return parseFloat(value.replace(/[^0-9.-]+/g, ""));
        }

        // --- DELETE ROW FUNCTION ---
        function deleteRow(button) {
            const row = button.closest('tr');
            if (confirm('Are you sure you want to delete this item?')) {
                row.remove();
                calculateTotals();
            }
        }

        // --- CORE CALCULATION LOGIC ---
        const vatRate = 0.0;
        const tableBody = document.querySelector('#item-table tbody');

        function calculateTotals() {
            let subtotal = 0;
            const itemRows = document.querySelectorAll('.item-row');

            itemRows.forEach(row => {
                const qtyElement = row.querySelector('.qty-cell');
                const rateElement = row.querySelector('.rate-cell');
                const lineTotalElement = row.querySelector('.line-total');

                const qty = parseCurrency(qtyElement.textContent);
                const rate = parseCurrency(rateElement.textContent);
                const lineTotal = qty * rate;
                
                subtotal += lineTotal;
                lineTotalElement.textContent = formatCurrency(lineTotal);
                
                if (rateElement.textContent !== 'R ' + formatCurrency(rate)) {
                    rateElement.textContent = 'R ' + formatCurrency(rate);
                }
            });

            const vatAmount = subtotal * vatRate;
            const grandTotal = subtotal + vatAmount;

            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('vat-amount').textContent = formatCurrency(vatAmount);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
        }

        function attachListeners() {
            const editableCells = document.querySelectorAll('.item-row .qty-cell, .item-row .rate-cell');
            editableCells.forEach(cell => {
                cell.removeEventListener('input', calculateTotals);
                cell.addEventListener('input', calculateTotals);
            });
        }

        // --- CLIENT INFORMATION FUNCTIONS ---
        function saveClientInfo() {
            const clientInfo = {
                name: document.getElementById('client-name-input').value,
                address: document.getElementById('client-address-textarea').value
            };
            
            localStorage.setItem('lastClientInfo', JSON.stringify(clientInfo));
        }

        function loadClientInfo() {
            const savedInfo = localStorage.getItem('lastClientInfo');
            if (savedInfo) {
                const clientInfo = JSON.parse(savedInfo);
                document.getElementById('client-name-input').value = clientInfo.name || '';
                document.getElementById('client-address-textarea').value = clientInfo.address || '';
            }
        }

        // --- DOCUMENT NUMBER MANAGEMENT ---
        function incrementDocumentNumber() {
            const currentType = documentTypeSelect.value;
            let currentNum = documentNumber.textContent;
            
            if (currentType === 'quote') {
                // Extract numeric part for quotes
                const match = currentNum.match(/\d+/);
                if (match) {
                    const nextNum = parseInt(match[0]) + 1;
                    documentNumber.textContent = nextNum.toString();
                    localStorage.setItem('lastQuoteNumber', nextNum.toString());
                }
            } else {
                // For invoices, handle INV- prefix
                if (currentNum.startsWith('INV-')) {
                    const numPart = currentNum.replace('INV-', '');
                    const match = numPart.match(/\d+/);
                    if (match) {
                        const nextNum = parseInt(match[0]) + 1;
                        documentNumber.textContent = 'INV-' + nextNum;
                        localStorage.setItem('lastInvoiceNumber', 'INV-' + nextNum);
                        invoiceReference.textContent = 'INV-' + nextNum;
                    }
                } else {
                    // If no INV- prefix, add it
                    const nextNum = 'INV-2508';
                    documentNumber.textContent = nextNum;
                    localStorage.setItem('lastInvoiceNumber', nextNum);
                    invoiceReference.textContent = nextNum;
                }
            }
        }

        // --- UTILITY FUNCTIONS ---
        function addRow() {
            const newRow = document.createElement('tr');
            newRow.classList.add('item-row');
            newRow.innerHTML = `
                <td contenteditable="true">Item</td>
                <td class="description-cell" contenteditable="true">
                    Description...
                    <button class="delete-btn" onclick="deleteRow(this)" title="Delete this item">×</button>
                </td>
                <td class="qty-cell" contenteditable="true">1</td>
                <td class="rate-cell" contenteditable="true">R 0.00</td>
                <td class="total-amount">R <span class="line-total">0.00</span></td>
            `;
            tableBody.appendChild(newRow);
            attachListeners();
            calculateTotals();
            
            // Auto-focus on the description cell for quick editing
            setTimeout(() => {
                newRow.querySelector('.description-cell').focus();
            }, 100);
        }

        function printDocument() {
            window.print();
        }

    window.addEventListener('orientationchange', function() {
    setTimeout(function() {
        document.body.style.display = 'none';
        document.body.offsetHeight; // Trigger reflow
        document.body.style.display = 'block';
    }, 100);
});

        // --- INITIALIZATION ---
        window.onload = function() {
            // Initialize document type
            initializeDocumentType();
            
            // Set current date
            const today = new Date();
            const formattedDate = today.toLocaleDateString('en-GB');
            document.getElementById('document-date').textContent = formattedDate;
            
            // Load saved data
            loadClientInfo();
            
            // Attach event listeners
            attachListeners();
            calculateTotals();
            
            // Auto-save client info when fields change
            const clientFields = document.querySelectorAll('#client-name-input, #client-address-textarea');
            clientFields.forEach(field => {
                field.addEventListener('change', saveClientInfo);
                field.addEventListener('input', function() {
                    clearTimeout(this.saveTimeout);
                    this.saveTimeout = setTimeout(saveClientInfo, 1000);
                });
            });
            
            // Update invoice reference when document number changes
            documentNumber.addEventListener('input', function() {
                if (documentTypeSelect.value === 'invoice') {
                    invoiceReference.textContent = this.textContent;
                }
            });
        };

    </script>
    <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('ServiceWorker registered:', registration);
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
        });


        // =============================================
// LOAD FROM MOBILE FUNCTIONALITY
// =============================================

function loadFromMobile() {
    // Get mobile documents from localStorage
    const mobileDocs = JSON.parse(localStorage.getItem('mobile_documents') || '[]');
    
    if (mobileDocs.length === 0) {
        alert('No mobile documents found.\n\nCreate documents using the mobile app first.');
        return;
    }
    
    // Create selection dialog
    let optionsHtml = '<h3>Select Mobile Document to Load:</h3>';
    optionsHtml += '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0; padding: 10px; border: 1px solid #ccc;">';
    
    mobileDocs.forEach((doc, index) => {
        const docDate = new Date(doc.date).toLocaleDateString();
        const clientName = doc.client.name || 'Unknown Client';
        const total = doc.totals.total ? 'R ' + doc.totals.total.toFixed(2) : 'R 0.00';
        
        optionsHtml += `
            <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;"
                 onclick="selectMobileDocument(${index})"
                 onmouseover="this.style.background='#f5f5f5'"
                 onmouseout="this.style.background='white'">
                <strong>${doc.id}</strong> (${doc.type})<br>
                <small>Client: ${clientName}</small><br>
                <small>Date: ${docDate} | Total: ${total} | Status: ${doc.status}</small>
            </div>
        `;
    });
    
    optionsHtml += '</div>';
    optionsHtml += '<button onclick="closeMobileDialog()" style="padding: 8px 16px; background: #ccc; border: none; margin-top: 10px;">Cancel</button>';
    
    // Show dialog
    const dialog = document.createElement('div');
    dialog.id = 'mobileDocDialog';
    dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 500px;
        width: 90%;
    `;
    dialog.innerHTML = optionsHtml;
    
    document.body.appendChild(dialog);
    
    // Add overlay
    const overlay = document.createElement('div');
    overlay.id = 'mobileDocOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
    `;
    document.body.appendChild(overlay);
}

function selectMobileDocument(index) {
    const mobileDocs = JSON.parse(localStorage.getItem('mobile_documents') || '[]');
    const doc = mobileDocs[index];
    
    if (!doc) {
        alert('Document not found');
        closeMobileDialog();
        return;
    }
    
    // Set document type
    const docTypeSelect = document.getElementById('document-type');
    docTypeSelect.value = doc.type;
    updateDocumentType(doc.type);
    
    // Set document number
    const docNumber = document.getElementById('document-number');
    docNumber.textContent = doc.id;
    
    // Set current date
    const today = new Date();
    const formattedDate = today.toLocaleDateString('en-GB');
    document.getElementById('document-date').textContent = formattedDate;
    
    // Set client info
    document.getElementById('client-name-input').value = doc.client.name || '';
    document.getElementById('client-address-textarea').value = doc.client.address || '';
    
    // Clear existing items
    const tableBody = document.querySelector('#item-table tbody');
    tableBody.innerHTML = '';
    
    // Add items from mobile
    doc.items.forEach(item => {
        const newRow = document.createElement('tr');
        newRow.classList.add('item-row');
        newRow.innerHTML = `
            <td contenteditable="true">${item.activity || 'Item'}</td>
            <td class="description-cell" contenteditable="true">
                ${item.description || 'Description...'}
                <button class="delete-btn" onclick="deleteRow(this)" title="Delete this item">×</button>
            </td>
            <td class="qty-cell" contenteditable="true">${item.quantity || 1}</td>
            <td class="rate-cell" contenteditable="true">R ${item.price ? item.price.toFixed(2) : '0.00'}</td>
            <td class="total-amount">R <span class="line-total">${item.lineTotal ? item.lineTotal.toFixed(2) : '0.00'}</span></td>
        `;
        tableBody.appendChild(newRow);
    });
    
    // Calculate totals
    attachListeners();
    calculateTotals();
    
    // Close dialog
    closeMobileDialog();
    
    // Show success message
    alert(`Document "${doc.id}" loaded successfully!`);
}

function closeMobileDialog() {
    const dialog = document.getElementById('mobileDocDialog');
    const overlay = document.getElementById('mobileDocOverlay');
    
    if (dialog) dialog.remove();
    if (overlay) overlay.remove();
}

// Add "Load from Mobile" button to your desktop action buttons
// Add this HTML to your action-buttons div:
// <button onclick="loadFromMobile()">Load from Mobile</button>

// Add this CSS for the button:
// #load-mobile-btn {
//     background-color: #4CAF50;
//     color: white;
//     border: none;
//     padding: 10px 18px;
//     cursor: pointer;
//     font-size: 13px;
//     margin: 4px;
//     border-radius: 4px;
//     transition: background-color 0.2s;
// }
// #load-mobile-btn:hover {
//     background-color: #45a049;
// }
    }
</script>
</body>
</html>
